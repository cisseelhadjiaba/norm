#!/bin/bash

depends_on cmake
depends_on libaio
depends_on libjemalloc
depends_on libncurses
depends_on xz
depends_on bzip2
depends_on liblzo
depends_on libreadline
depends_on libxml
needs_tool bison
depends_on liblz4
depends_on libsnappy
depends_on zeromq
depends_on msgpack
depends_on libevent
depends_on openssl
depends_on libcap
depends_on libpam

OURNAME=`basename "${BASH_SOURCE[0]}"`
if [[ $OURNAME == mariadb-devel ]]; then
fetch_source https://downloads.mariadb.org/interstitial/mariadb-10.3.5/source/mariadb-10.3.5.tar.gz 4e0664e65256f8165ea91ae50a72bc140469208c
else
fetch_source https://downloads.mariadb.org/interstitial/mariadb-10.2.14/source/mariadb-10.2.14.tar.gz e809ea91405ddb4b3239ca67f1bba6414172b283
fi

do_unpack
do_patch_inline -p0 << EOF
--- cmake/readline.cmake
+++ cmake/readline.cmake
@@ -230,6 +230,7 @@
     SET(CMAKE_REQUIRED_LIBRARIES)
     SET(CMAKE_REQUIRED_INCLUDES)
   ENDIF(NOT WIN32)
-  CHECK_INCLUDE_FILES ("curses.h;term.h" HAVE_TERM_H)
+  CHECK_INCLUDE_FILES ("curses.h" HAVE_CURSES_H)
+  CHECK_INCLUDE_FILES ("term.h" HAVE_TERM_H)
 ENDMACRO()
 
EOF
do_compile -DBUILD_CONFIG=mysql_release -DCURSES_INCLUDE_PATH="$ESCAPED_PREFIX/include/ncurses" -DCMAKE_C_FLAGS="$CPPFLAGS -I$ESCAPED_PREFIX/include/ncurses" -DCMAKE_CXX_FLAGS="$CPPFLAGS -I$ESCAPED_PREFIX/include/ncurses" -DWITH_SSL=system -DWITH_ZLIB=system -DWITH_LIBEVENT=system -DWITH_JEMALLOC=system
