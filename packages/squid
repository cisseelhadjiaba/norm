#!/bin/bash

needs_tool autoconf automake libtool
depends_on libdb ## opportunistic linking, no way to disable

fetch_source http://www.squid-cache.org/Versions/v3/3.5/squid-3.5.27.tar.xz 1e69c96d13cd49844da3bcf33a0b428fbe7b6f77

do_unpack

## patch out attempts to link against LDAP
sed -i.bak 's/LDAP//' "$SRCDIR"/helpers/basic_auth/LDAP/required.m4
sed -i.bak 's/LDAP_group//' "$SRCDIR"/helpers/external_acl/LDAP_group/required.m4
sed -i.bak 's/LDAP//' "$SRCDIR"/helpers/digest_auth/LDAP/required.m4
sed -i.bak 's/eDirectory//' "$SRCDIR"/helpers/digest_auth/eDirectory/required.m4
sed -i.bak 's/eDirectory_userip//' "$SRCDIR"/helpers/external_acl/eDirectory_userip/required.m4

## patch out attempts to link against PAM
sed -i.bak 's/PAM//' "$SRCDIR"/helpers/basic_auth/PAM/required.m4

## patch out attempts to link against SASL
sed -i.bak 's/SASL//' "$SRCDIR"/helpers/basic_auth/SASL/required.m4

do_autoreconf

pushd_src
cd libltdl
autoreconf -f -i -v
popd_src

CONFFLAGS=(
--without-gnutls
--without-nettle
--without-libcap
--without-mit-krb5
--without-heimdal-krb5
--with-included-ltdl ## otherwise links with system one
)

do_compile "${CONFFLAGS[@]}"
