#!/bin/bash

depends_on pkg-config # otherwise it won't install .pc files
fetch_source http://ftpmirror.gnu.org/ncurses/ncurses-6.0.tar.gz acd606135a5124905da770803c05f1f20dd3b21c
fetch_file http://invisible-mirror.net/archives/ncurses/6.0/patch-6.0-20170930.sh.gz a261fcb1280d67304cc932e5f9838a66d1d743cb

CONFOPTS=(
--enable-pc-files
--disable-termcap
--enable-rpath
--enable-const
--enable-symlinks
--without-ada
--without-cxx-binding
--with-shared
--without-debug
--with-pkg-config-libdir="$PREFIX/lib/pkgconfig"
)

[[ $OSTYPE == *linux* ]] && CONFOPTS+=(--with-termlib) ## tinfo.pc from system if present will make things more difficult

prepare() {
do_unpack
pushd_src
cat "$CACHEDIR/$FILENAME" | gzip -d > rollup.sh
sh rollup.sh
popd_src
}
prepare && LDFLAGS=" " do_compile "${CONFOPTS[@]}"
prepare && LDFLAGS=" " do_compile "${CONFOPTS[@]}" --enable-widec
# link tinfo when linking ncurses
# lame, for example, doesn't link tinfo explicitly when linking ncurses
if [[ $OSTYPE != *darwin* ]]; then
    rm -f $PREFIX/lib/libncurses{,w}.so
    echo "INPUT(libncurses.so.6 -ltinfo)" > $PREFIX/lib/libncurses.so
    echo "INPUT(libncursesw.so.6 -ltinfow)" > $PREFIX/lib/libncursesw.so
    echo -e "/* We use a linker script rather than a symlink to work around\n   an ldconfig bug, see http://bugs.debian.org/249122. */\nGROUP( libtinfo.so )" > $PREFIX/lib/libtermcap.so
    # alias termcap into tinfo -- libedit for example looks for it everywhere but tinfo
    ln -fs libtinfo.a $PREFIX/lib/libtermcap.a
    ln -fs libncurses.so $PREFIX/lib/libcurses.so
else
    ln -fs libncurses.dylib $PREFIX/lib/libcurses.dylib
fi
ln -fs libncurses.a $PREFIX/lib/libcurses.a
