#!/bin/bash

## TODO: timestamps in tests are broken if /etc/localtime is not present
[[ ! -e /etc/localtime ]] && log "$FORMULA requires /etc/localtime to successfully test" && false

depends_on python ## wants python headers and libs that might not be installed on system
needs_tool git
! is_without tests && needs_tool rsync ## needed to run tests

fetch_source https://github.com/bup/bup/archive/0.29.1.tar.gz c421d4100b07294b3c34fa0f56cbcdbb0b5f9252

do_unpack
do_patch_inline -p0 << 'EOF'
--- t/test-rm.sh
+++ t/test-rm.sh
@@ -51,9 +51,11 @@
 observed="$(compare-trees bup/ bup-baseline/ | LC_ALL=C sort)" || exit $?
 wv_matches_rx "$observed" \
 '\*deleting[ ]+logs/refs/heads/src
-\*deleting[ ]+refs/heads/src
+\*deleting[ ]+refs/heads/src(
+\.d\.\.t\.\.\.\.\.\.[ ]+\./)?
 \.d\.\.t\.\.\.[.]*[ ]+logs/refs/heads/
-\.d\.\.t\.\.\.[.]*[ ]+refs/heads/'
+\.d\.\.t\.\.\.[.]*[ ]+refs/heads/(
+>f\+\+\+\+\+\+\+\+\+[ ]+packed-refs)?'
 
 
 WVSTART "rm /foo (one of many)"
@@ -71,9 +73,11 @@
 observed="$(compare-trees bup/ bup-baseline/ | LC_ALL=C sort)" || exit $?
 wv_matches_rx "$observed" \
 "\*deleting[ ]+logs/refs/heads/src
-\*deleting[ ]+refs/heads/src
+\*deleting[ ]+refs/heads/src(
+\.d\.\.t\.\.\.\.\.\.[ ]+\./)?
 \.d\.\.t\.\.\.[.]*[ ]+logs/refs/heads/
-\.d\.\.t\.\.\.[.]*[ ]+refs/heads/"
+\.d\.\.t\.\.\.[.]*[ ]+refs/heads/(
+>f\+\+\+\+\+\+\+\+\+[ ]+packed-refs)?"
 
 
 WVSTART "rm /foo /bar (multiple of many)"
@@ -93,9 +97,11 @@
 "\*deleting[ ]+logs/refs/heads/src-2
 \*deleting[ ]+logs/refs/heads/src-4
 \*deleting[ ]+refs/heads/src-2
-\*deleting[ ]+refs/heads/src-4
+\*deleting[ ]+refs/heads/src-4(
+\.d\.\.t\.\.\.\.\.\.[ ]+\./)?
 \.d\.\.t\.\.\.[.]*[ ]+logs/refs/heads/
-\.d\.\.t\.\.\.[.]*[ ]+refs/heads/"
+\.d\.\.t\.\.\.[.]*[ ]+refs/heads/(
+>f\+\+\+\+\+\+\+\+\+[ ]+packed-refs)?"
 
 
 WVSTART "rm /foo /bar (all)"
@@ -115,9 +121,11 @@
 \*deleting[ ]+refs/heads/src-2
 \*deleting[ ]+refs/heads/src-3
 \*deleting[ ]+refs/heads/src-4
-\*deleting[ ]+refs/heads/src-5
+\*deleting[ ]+refs/heads/src-5(
+\.d\.\.t\.\.\.\.\.\.[ ]+\./)?
 \.d\.\.t\.\.\.[.]*[ ]+logs/refs/heads/
-\.d\.\.t\.\.\.[.]*[ ]+refs/heads/"
+\.d\.\.t\.\.\.[.]*[ ]+refs/heads/(
+>f\+\+\+\+\+\+\+\+\+[ ]+packed-refs)?"
 
 
 WVSTART "rm /foo/bar (lone save - equivalent to rm /foo)"
@@ -136,9 +144,11 @@
 observed="$(compare-trees bup/ bup-baseline/ | LC_ALL=C sort)" || exit $?
 wv_matches_rx "$observed" \
 "\*deleting[ ]+logs/refs/heads/src
-\*deleting[ ]+refs/heads/src
+\*deleting[ ]+refs/heads/src(
+\.d\.\.t\.\.\.\.\.\.[ ]+\./)?
 \.d\.\.t\.\.\.[.]*[ ]+logs/refs/heads/
-\.d\.\.t\.\.\.[.]*[ ]+refs/heads/"
+\.d\.\.t\.\.\.[.]*[ ]+refs/heads/(
+>f\+\+\+\+\+\+\+\+\+[ ]+packed-refs)?"
 
 
 verify-changes-caused-by-rewriting-save()
EOF
pushd_src
./configure
do_make
do_test
do_install PREFIX="$PREFIX"
popd_src
