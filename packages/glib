#!/bin/bash

depends_on autoconf automake libtool ## for autoreconf
depends_on zlib
depends_on libffi
depends_on libelf # optional but if system provides one, we'll depend for something outside the system
depends_on pkg-config # to find zlib
depends_on gettext
depends_on libpcre

fetch_source https://download.gnome.org/sources/glib/2.52/glib-2.52.3.tar.xz 9e31cce788d018894e6e0b1350263bc11b41cff8

unset EXTRAFLAGS NEW_LDFLAGS
cc_addflags EXTRAFLAGS -Wno-format-nonliteral ## gcc 6.1 is too strict for this old glib
cc_addflags NEW_LDFLAGS -Wl,-z,defs

do_unpack
do_patch_inline << EOF
--- a/gio/Makefile.am
+++ b/gio/Makefile.am
@@ -244,8 +244,6 @@
 platform_deps += win32/libgiowin32.la
 endif
 
-SUBDIRS += . tests
-
 if HAVE_FAM
 SUBDIRS += fam
 endif
EOF

do_autoreconf
PYTHON=/bin/true CPPFLAGS="$CPPFLAGS $EXTRAFLAGS" LDFLAGS="$NEW_LDFLAGS" do_compile --disable-fam --with-pcre=system --disable-libmount
