#!/bin/bash

needs_tool pkg-config # to find zlib
depends_on zlib
depends_on libffi
needs_tool python # bin/gdbus-codegen is in python, needed by libgtk3
needs_tool autoconf automake libtool
depends_on libpcre ## new dependency as of 2.58
needs_tool gettext

fetch_source https://ftp.gnome.org/pub/gnome/sources/glib/2.58/glib-2.58.0.tar.xz c00e433c56e0ba3541abc5222aeca4136de10fb8

unset EXTRAFLAGS NEW_LDFLAGS
cc_addflags EXTRAFLAGS -Wno-format-nonliteral ## gcc 6.1 is too strict for this old glib
cc_addflags NEW_LDFLAGS -Wl,-z,defs -Wl,-z,now

do_unpack
sed -i.bak 's|test $have_libmount = no|false|' "$SRCDIR"/configure.ac
sed -i.bak "s|/usr/local/share/:/usr/share/|$PREFIX/share/:/usr/local/share/:/usr/share/|" "$SRCDIR"/gio/xdgmime/xdgmime.c "$SRCDIR"/glib/gutils.c
pushd_src
./autogen.sh
popd_src

CONFFLAGS=(
--disable-fam
--disable-libelf
--disable-selinux
--with-pcre=internal
--disable-libmount
--disable-dtrace
--disable-libmount
)
CPPFLAGS="$CPPFLAGS $EXTRAFLAGS" LDFLAGS="$NEW_LDFLAGS" do_compile "${CONFFLAGS[@]}"
