#!/bin/bash

needs_tool pkg-config # to find zlib
depends_on zlib
depends_on libffi
needs_tool python # bin/gdbus-codegen is in python, needed by libgtk3

fetch_source http://ftp.gnome.org/pub/gnome/sources/glib/2.56/glib-2.56.1.tar.xz 4db098c15b9d57c37bb504a6f58ebe717994e6f2

unset EXTRAFLAGS NEW_LDFLAGS
cc_addflags EXTRAFLAGS -Wno-format-nonliteral ## gcc 6.1 is too strict for this old glib
cc_addflags NEW_LDFLAGS -Wl,-z,defs

do_unpack
sed -i.bak 's|test "$gt_cv_have_gettext" != "yes"|false|;' "$SRCDIR"/configure
sed -i.bak "s|/usr/local/share/:/usr/share/|$PREFIX/share/:/usr/local/share/:/usr/share/|" "$SRCDIR"/gio/xdgmime/xdgmime.c "$SRCDIR"/glib/gutils.c
sed -i.bak 's|#include <libintl.h>|#include "glibintl.h"|' "$SRCDIR"/glib/{ggettext.c,gi18n.h,gi18n-lib.h}
sed -i.bak 's|^\(#define dngettext.*\)|\1\
#define ngettext(String1,String2,N) ((N) == 1 ? (String1) : (String2))|' "$SRCDIR"/glib/glibintl.h

CONFFLAGS=(
--disable-fam
--disable-libelf
--disable-selinux
--with-pcre=internal
--disable-libmount
--disable-dtrace
)
CPPFLAGS="$CPPFLAGS $EXTRAFLAGS" LDFLAGS="$NEW_LDFLAGS" do_compile "${CONFFLAGS[@]}"
