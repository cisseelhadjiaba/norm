#!/bin/bash

depends_on autoconf automake libtool ## for autoreconf
depends_on zlib
depends_on libffi
depends_on libelf # optional but if system provides one, we'll depend for something outside the system
depends_on pkg-config # to find zlib
depends_on gettext
depends_on libpcre
needs_tool python # gdbus-codegen is in python, needed by libgtk3 later

fetch_source https://download.gnome.org/sources/glib/2.56/glib-2.56.0.tar.xz 712f8a67417cc606b1b2b75718f9a65354b2cdfe

unset EXTRAFLAGS NEW_LDFLAGS
cc_addflags EXTRAFLAGS -Wno-format-nonliteral ## gcc 6.1 is too strict for this old glib
cc_addflags NEW_LDFLAGS -Wl,-z,defs

do_unpack
do_patch_inline << 'EOF'
--- a/configure.ac
+++ b/configure.ac
@@ -175,24 +175,7 @@
 AC_SUBST(LIB_EXE_MACHINE_FLAG)
 
 glib_have_carbon=no
-AC_MSG_CHECKING([for Mac OS X Carbon support])
-AC_TRY_CPP([
-#include <Carbon/Carbon.h>
-#include <CoreServices/CoreServices.h>
-], glib_have_carbon=yes)
-
-AC_MSG_RESULT([$glib_have_carbon])
-
 glib_have_cocoa=no
-AC_MSG_CHECKING([for Mac OS X Cocoa support])
-AC_TRY_CPP([
-#include <Cocoa/Cocoa.h>
-#ifdef GNUSTEP_BASE_VERSION
-#error "Detected GNUstep, not Cocoa"
-#endif
-], glib_have_cocoa=yes)
-
-AC_MSG_RESULT([$glib_have_cocoa])
 
 AM_CONDITIONAL(OS_WIN32, [test "$glib_native_win32" = "yes"])
 AM_CONDITIONAL(OS_WIN32_X64, [test "$LIB_EXE_MACHINE_FLAG" = "X64"])
EOF

sed -i.bak "s|/usr/local/share/:/usr/share/|$PREFIX/share/:/usr/local/share/:/usr/share/|" "$SRCDIR"/gio/xdgmime/xdgmime.c "$SRCDIR"/glib/gutils.c
do_autoreconf
CPPFLAGS="$CPPFLAGS $EXTRAFLAGS" LDFLAGS="$NEW_LDFLAGS" do_compile --disable-fam --with-pcre=system --disable-libmount --disable-dtrace
