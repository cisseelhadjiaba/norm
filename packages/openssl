#!/bin/bash
depends_on zlib

## don't use https to download openssl source because openssl might be too old to even establish a connection!
fetch_source http://security.debian.org/debian-security/pool/updates/main/o/openssl/openssl_1.0.1e.orig.tar.gz 3f1b1223c9e8189bfe4e186d86449775bd903460
fetch_debian http://security.debian.org/debian-security/pool/updates/main/o/openssl/openssl_1.0.1e-2+deb7u16.debian.tar.gz 3e284fe63bbc521c5f67bda8243080383fe757ae

BUILDCONF=gcc
cc_addflags EXTRAFLAGS -g -O2 -fstack-protector --param=ssp-buffer-size=4 -Wformat -Werror=format-security -D_FORTIFY_SOURCE=2 -Wl,-z,relro -Wa,--noexecstack -Wall -fno-strict-aliasing
cc_addflag EXTRAFLAGS -march=native -march=i686
SSLCONFIG="no-ssl2 threads zlib --openssldir=$PREFIX/etc/ssl"

[[ $OSTYPE == *linux* ]] && [[ $HOSTTYPE == i?86 ]] && BUILDCONF=linux-elf
[[ $OSTYPE == *linux* ]] && [[ $HOSTTYPE == x86_64 ]] && BUILDCONF=debian-amd64 && SSLCONFIG="$SSLCONFIG enable-ec_nistp_64_gcc_128"
[[ $OSTYPE == *darwin* ]] && BUILDCONF=darwin64-x86_64-cc

do_undebian

fix_makefile() {
    # get rid of built-in O3, omit-frame-pointer and arch/cpu/machine settings -> faster binary
    sed -i -e 's:-fomit-frame-pointer ::g' \
           -e 's:-O[0-9] ::g' \
           -e 's:-m(arch|cpu)=[-a-z0-9]* ::g' \
           -e 's:-m[a-z0-9]* ::g' Makefile || false
    sed -i "s:^CFLAG=.*\$:& $EXTRAFLAGS:" Makefile || false
}

pushd_src

## make both static and shared versions
log "Configuring static openssl"
./Configure no-shared --prefix=$PREFIX $LDFLAGS $SSLCONFIG $BUILDCONF
fix_makefile
NOPARALLEL=1 do_make all
NOPARALLEL=1 do_make test
mv apps/openssl apps/openssl.static
mv libcrypto.a libcrypto.static
mv libssl.a libssl.static
do_make -f Makefile clean
log "Configuring shared openssl"
./Configure shared --prefix=$PREFIX $LDFLAGS $SSLCONFIG $BUILDCONF
fix_makefile
NOPARALLEL=1 do_make all
NOPARALLEL=1 do_make test
do_install MANDIR=$PREFIX/share/man
mkdir -p $PREFIX/lib $PREFIX/bin
install -p -m755 apps/openssl.static $PREFIX/bin/openssl
install -p -m644 libcrypto.static $PREFIX/lib/libcrypto.a
install -p -m644 libssl.static $PREFIX/lib/libssl.a
popd
