#!/bin/bash

depends_on libnspr
depends_on zlib
depends_on sqlite3

major=3
minor=31
patch=1

## DO NOT FORGET TO UPDATE VARIABLES ABOVE
fetch_source https://ftp.mozilla.org/pub/security/nss/releases/NSS_3_31_1_RTM/src/nss-3.31.1.tar.gz cd62556e63ad29c42e43e05c0a8bf2398d19059c

EXTRA_OPTIONS=
[[ $HOSTTYPE == *64* ]] && EXTRA_OPTIONS="USE_64=1"


do_unpack
pushd_src
make -C nss all \
                                         MOZILLA_CLIENT=1 NSPR_INCLUDE_DIR=$PREFIX/include/nspr \
                                         NSPR_LIB_DIR=$PREFIX/lib BUILD_OPT=1 NS_USE_GCC=1 \
                                         NSS_USE_SYSTEM_SQLITE=1 NSS_ENABLE_ECC=1 CHECKLOC= \
                                         $EXTRA_OPTIONS \
                                         USE_SYSTEM_ZLIB=1 OPTIMIZER="$CFLAGS $CPPFLAGS"


cat nss/pkg/pkg-config/nss-config.in | sed -e "s|@prefix@|$PREFIX|" -e "s/@MOD_MAJOR_VERSION@/$major/" -e "s/@MOD_MINOR_VERSION@/$minor/" -e "s/@MOD_PATCH_VERSION@/$patch/" > nss/pkg/pkg-config/nss-config
cat nss/pkg/pkg-config/nss.pc.in     | sed -e "s|%prefix%|$PREFIX|" -e "s|%NSS_VERSION%|$major.$minor.$patch|" -e 's|%exec_prefix%|${prefix}|' -e 's|%libdir%|${prefix}/lib|' -e 's|%includedir%|${prefix}/include/nss|' -e 's| >= %NSPR_VERSION%||' > nss/pkg/pkg-config/nss.pc

DISTDIR=dist/Linux*_OPT.OBJ

mkdir -p $PREFIX/bin
mkdir -p $PREFIX/lib
mkdir -p $PREFIX/lib/nss
mkdir -p $PREFIX/lib/pkgconfig
mkdir -p $PREFIX/include/nss
install -m 644 -s -t $PREFIX/lib \
        $DISTDIR/lib/libnss3.so \
        $DISTDIR/lib/libnssutil3.so \
        $DISTDIR/lib/libsmime3.so \
        $DISTDIR/lib/libssl3.so
install -m 644 -s -t $PREFIX/lib/nss \
        $DISTDIR/lib/libfreebl3.so \
        $DISTDIR/lib/libsoftokn3.so \
        $DISTDIR/lib/libnssdbm3.so \
        $DISTDIR/lib/libnssckbi.so
ln -fs nss/libfreebl3.so $PREFIX/lib
ln -fs nss/libsoftokn3.so $PREFIX/lib
ln -fs nss/libnssdbm3.so $PREFIX/lib
ln -fs nss/libnssckbi.so $PREFIX/lib
install -m 644 -t $PREFIX/include/nss dist/public/nss/*
install -m 644 -t $PREFIX/lib $DISTDIR/lib/libcrmf.a
install -m 644 -t $PREFIX/lib/pkgconfig nss/pkg/pkg-config/nss.pc
install -m 755 -t $PREFIX/bin nss/pkg/pkg-config/nss-config
install -m 755 -s -t $PREFIX/bin $DISTDIR/bin/{certutil,cmsutil,crlutil,modutil,pk12util,shlibsign,signtool,signver,ssltap,pwdecrypt}
popd

