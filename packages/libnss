#!/bin/bash

depends_on libnspr
depends_on zlib
depends_on sqlite3

major=3
minor=31
patch=1

## DO NOT FORGET TO UPDATE VARIABLES ABOVE
fetch_source https://ftp.mozilla.org/pub/security/nss/releases/NSS_3_31_1_RTM/src/nss-3.31.1.tar.gz cd62556e63ad29c42e43e05c0a8bf2398d19059c

EXTRA_OPTIONS=
[[ $HOSTTYPE == *64* ]] && EXTRA_OPTIONS="USE_64=1"


do_unpack
pushd_src
make -C nss all \
                                         MOZILLA_CLIENT=1 NSPR_INCLUDE_DIR=$PREFIX/include/nspr \
                                         NSPR_LIB_DIR=$PREFIX/lib BUILD_OPT=1 NS_USE_GCC=1 \
                                         NSS_USE_SYSTEM_SQLITE=1 NSS_ENABLE_ECC=1 CHECKLOC= \
                                         $EXTRA_OPTIONS \
                                         USE_SYSTEM_ZLIB=1 OPTIMIZER="$CFLAGS $CPPFLAGS"


cat nss/pkg/pkg-config/nss-config.in | sed -e "s|@prefix@|$PREFIX|" -e "s/@MOD_MAJOR_VERSION@/$major/" -e "s/@MOD_MINOR_VERSION@/$minor/" -e "s/@MOD_PATCH_VERSION@/$patch/" > nss/pkg/pkg-config/nss-config
cat nss/pkg/pkg-config/nss.pc.in     | sed -e "s|%prefix%|$PREFIX|" -e "s|%NSS_VERSION%|$major.$minor.$patch|" -e 's|%exec_prefix%|${prefix}|' -e 's|%libdir%|${prefix}/lib|' -e 's|%includedir%|${prefix}/include/nss|' -e 's| >= %NSPR_VERSION%||' > nss/pkg/pkg-config/nss.pc

DISTDIR=dist/Linux*_OPT.OBJ
DYLIBEXT=.so
[[ $OSTYPE == *darwin* ]] && DISTDIR=dist/Darwin*_OPT.OBJ && DYLIBEXT=.dylib

mkdir -p $PREFIX/bin
mkdir -p $PREFIX/lib
mkdir -p $PREFIX/lib/nss
mkdir -p $PREFIX/lib/pkgconfig
mkdir -p $PREFIX/include/nss
install -m 644 \
        $DISTDIR/lib/libnss3$DYLIBEXT \
        $DISTDIR/lib/libnssutil3$DYLIBEXT \
        $DISTDIR/lib/libsmime3$DYLIBEXT \
        $DISTDIR/lib/libssl3$DYLIBEXT \
        $PREFIX/lib
install -m 644 \
        $DISTDIR/lib/libfreebl3$DYLIBEXT \
        $DISTDIR/lib/libsoftokn3$DYLIBEXT \
        $DISTDIR/lib/libnssdbm3$DYLIBEXT \
        $DISTDIR/lib/libnssckbi$DYLIBEXT \
        $PREFIX/lib/nss
ln -fs nss/libfreebl3$DYLIBEXT $PREFIX/lib
ln -fs nss/libsoftokn3$DYLIBEXT $PREFIX/lib
ln -fs nss/libnssdbm3$DYLIBEXT $PREFIX/lib
ln -fs nss/libnssckbi$DYLIBEXT $PREFIX/lib
install -m 644 dist/public/nss/* $PREFIX/include/nss
install -m 644 $DISTDIR/lib/libcrmf.a $PREFIX/lib
install -m 644 nss/pkg/pkg-config/nss.pc $PREFIX/lib/pkgconfig
install -m 755 nss/pkg/pkg-config/nss-config $PREFIX/bin
install -m 755 $DISTDIR/bin/{certutil,cmsutil,crlutil,modutil,pk12util,shlibsign,signtool,signver,ssltap,pwdecrypt} $PREFIX/bin
popd

