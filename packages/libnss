#!/bin/bash

depends_on libnspr
depends_on zlib
depends_on sqlite3

major=3
minor=39
patch=0

## DO NOT FORGET TO UPDATE VARIABLES ABOVE
fetch_source https://ftp.mozilla.org/pub/security/nss/releases/NSS_3_39_RTM/src/nss-3.39.tar.gz 351e0e9607ead50174efe5f5107e2dc97e7358f2

EXTRA_OPTIONS=
[[ $HOSTTYPE == *64* ]] && EXTRA_OPTIONS="USE_64=1"


do_unpack
pushd_src
MAKEFLAGS=(
MOZILLA_CLIENT=1
NSPR_INCLUDE_DIR="$PREFIX"/include/nspr
NSPR_LIB_DIR="$PREFIX"/lib
BUILD_OPT=1
NSS_USE_SYSTEM_SQLITE=1
USE_SYSTEM_ZLIB=1
OPTIMIZER="-O2 -g $CPPFLAGS"
$EXTRA_OPTIONS
)
sed -i.bak 's|@executable_path|@rpath|' nss/coreconf/Darwin.mk
make -C nss all "${MAKEFLAGS[@]}"


cat nss/pkg/pkg-config/nss-config.in | sed -e "s|@prefix@|$PREFIX|" -e "s/@MOD_MAJOR_VERSION@/$major/" -e "s/@MOD_MINOR_VERSION@/$minor/" -e "s/@MOD_PATCH_VERSION@/$patch/" > nss/pkg/pkg-config/nss-config
cat nss/pkg/pkg-config/nss.pc.in     | sed -e "s|%prefix%|$PREFIX|" -e "s|%NSS_VERSION%|$major.$minor.$patch|" -e 's|%exec_prefix%|${prefix}|' -e 's|%libdir%|${prefix}/lib|' -e 's|%includedir%|${prefix}/include/nss|' -e 's| >= %NSPR_VERSION%||' > nss/pkg/pkg-config/nss.pc

DISTDIR=dist/Linux*_OPT.OBJ
DYLIBEXT=.so
[[ $OSTYPE == *darwin* ]] && DISTDIR=dist/Darwin*_OPT.OBJ && DYLIBEXT=.dylib

mkdir -p $PREFIX/bin
mkdir -p $PREFIX/lib
mkdir -p $PREFIX/lib/nss
mkdir -p $PREFIX/lib/pkgconfig
mkdir -p $PREFIX/include/nss
install -m 644 \
        $DISTDIR/lib/libnss3$DYLIBEXT \
        $DISTDIR/lib/libnssutil3$DYLIBEXT \
        $DISTDIR/lib/libsmime3$DYLIBEXT \
        $DISTDIR/lib/libssl3$DYLIBEXT \
        $PREFIX/lib
install -m 644 \
        $DISTDIR/lib/libfreebl3$DYLIBEXT \
        $DISTDIR/lib/libsoftokn3$DYLIBEXT \
        $DISTDIR/lib/libnssdbm3$DYLIBEXT \
        $DISTDIR/lib/libnssckbi$DYLIBEXT \
        $PREFIX/lib/nss
ln -fs nss/libfreebl3$DYLIBEXT $PREFIX/lib
ln -fs nss/libsoftokn3$DYLIBEXT $PREFIX/lib
ln -fs nss/libnssdbm3$DYLIBEXT $PREFIX/lib
ln -fs nss/libnssckbi$DYLIBEXT $PREFIX/lib
install -m 644 dist/public/nss/* $PREFIX/include/nss
install -m 644 $DISTDIR/lib/libcrmf.a $PREFIX/lib
install -m 644 nss/pkg/pkg-config/nss.pc $PREFIX/lib/pkgconfig
install -m 755 nss/pkg/pkg-config/nss-config $PREFIX/bin
install -m 755 $DISTDIR/bin/{certutil,cmsutil,crlutil,modutil,pk12util,shlibsign,signtool,signver,ssltap,pwdecrypt} $PREFIX/bin
popd

