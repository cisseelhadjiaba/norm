#!/bin/bash

needs_tool python
needs_tool pkg-config
depends_on glib
depends_on pixman

depends_on libsdl2 ## other option is heavy gtk2 or gtk3
depends_on libfdt ## opportunistic linking, no easy way to disable
depends_on libcap ## opportunistic linking, no way to disable

fetch_source https://wiki.qemu-project.org/download/qemu-3.0.0.tar.bz2 68ad39f46d197a71689417c76d3a50c52a71ce68

CONFFLAGS=(
--disable-seccomp ## seccomp causes troubles with musl/alpine

--extra-cflags="$CPPFLAGS"
--extra-ldflags="$LDFLAGS"

## opportunistic linking
--disable-cap-ng
--disable-glusterfs
--disable-rbd
--disable-libssh2
--disable-libnfs
--disable-curses
--disable-gtk
--disable-libiscsi
--disable-curl
--disable-linux-aio
--disable-nettle
--disable-gnutls
--disable-gcrypt
--disable-bzip2
--disable-brlapi
--disable-smartcard
--disable-usb-redir
--disable-libusb
--disable-vde
--disable-opengl
--disable-numa
--disable-bluez
--disable-vnc-png
--disable-vnc-jpeg
--disable-vnc-sasl
--disable-xen
--disable-lzo
--disable-snappy
--disable-spice
)


do_unpack
sed -i.bak 's/xkbcommon=""/xkbcommon="no"/g' "$SRCDIR"/configure
sed -i.bak 's/$pkg_config --exists "x11"/false/g' "$SRCDIR"/configure

## notest: testing hangs because test scripts do not kill a qemu process
do_compile_notest "${CONFFLAGS[@]}"
