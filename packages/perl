#!/bin/bash

depends_on libdb
depends_on libgdbm

fetch_source http://www.cpan.org/src/5.0/perl-5.22.1.tar.gz 105fe2515cb6e7d22e583336f93823d7407b9359

do_unpack
pushd_src
do_patch_inline << 'EOF' ## perl's MakeMaker will put everything it sees into LD_RUN_PATH, overwriting our own
diff --git a/cpan/ExtUtils-MakeMaker/lib/ExtUtils/Liblist/Kid.pm b/cpan/ExtUtils-MakeMaker/lib/ExtUtils/Liblist/Kid.pm
index e39c8b2..0b933ce 100644
--- a/cpan/ExtUtils-MakeMaker/lib/ExtUtils/Liblist/Kid.pm
+++ b/cpan/ExtUtils-MakeMaker/lib/ExtUtils/Liblist/Kid.pm
@@ -56,6 +56,9 @@ sub _unix_os2_ext {
     my ( $pwd )   = cwd();    # from Cwd.pm
     my ( $found ) = 0;

+    # Debian-specific: don't use LD_RUN_PATH for standard dirs
+    $ld_run_path_seen{$_}++ for @libpath;
+
     foreach my $thislib ( split ' ', $potential_libs ) {

         # Handle possible linker path arguments.
--- a/t/porting/customized.dat	2015-10-31 16:36:16.000000000 +0300
+++ b/t/porting/customized.dat	2016-01-19 02:15:20.116000000 +0300
@@ -1,7 +1,7 @@
 CPAN cpan/CPAN/lib/CPAN.pm ce62c43d72f101c011184dbbc59e21c2790826f0
 ExtUtils::MakeMaker cpan/ExtUtils-MakeMaker/lib/ExtUtils/Command/MM.pm 7f4dfd0fe884bd42412bcf04ca80ef97b39c1d54
 ExtUtils::MakeMaker cpan/ExtUtils-MakeMaker/lib/ExtUtils/Liblist.pm bef099988b15fb0b2a1f5ac48c01af1f7f36d329
-ExtUtils::MakeMaker cpan/ExtUtils-MakeMaker/lib/ExtUtils/Liblist/Kid.pm 8168e18f0e3ce3ece4bb7e7c72d57ec07c67c402
+ExtUtils::MakeMaker cpan/ExtUtils-MakeMaker/lib/ExtUtils/Liblist/Kid.pm 3493ae6f93264e967f58dedaa3dbf3dbcb249853
 ExtUtils::MakeMaker cpan/ExtUtils-MakeMaker/lib/ExtUtils/MakeMaker.pm 7115e97a53559cb3ec061dd6f7f344e522724c4a
 ExtUtils::MakeMaker cpan/ExtUtils-MakeMaker/lib/ExtUtils/MakeMaker/Config.pm f8db8d4245bf0684b8210c811f50d7cfb1a27d78
 ExtUtils::MakeMaker cpan/ExtUtils-MakeMaker/lib/ExtUtils/MakeMaker/FAQ.pod 757bffb47857521311f8f3bde43ebe165f8d5191
EOF

## perl's build system doesn't honor CPPFLAGS and LDFLAGS environment variables, so it will link against system libraries only
## also, by default perl is very crippled -- no 64bit ints, no support for >2GB files, no threads, no shared libraries
## and telling that cc is GCC sets appropriate defaults
./Configure -des \
            -Dprefix=$PREFIX \
            -Dloclibpth="$PREFIX/lib" \
            -Dlocincpth="$PREFIX/include" \
            -Accflags="$CPPFLAGS" \
            -Aldflags="$LDFLAGS" \
            -Alddlflags="-shared $LDFLAGS" \
            -Duseshrplib -Dusethreads -Duselargefiles -Duse64bitint \
            -Dcc=gcc
do_make
## a lot of stuff depends on perl, so it must pass all self checks
## in order to do so, it must be run in clean environment so it won't try to use proxies
! is_without tests && env - PATH="$PATH" make test
do_install
popd
