#!/bin/bash

needs_tool cmake
needs_tool nasm

fetch_source https://bitbucket.org/multicoreware/x265/downloads/x265_2.8.tar.gz e2ef1ad186d9581239463d4e5177a25bc57b9fc0

do_unpack
do_patch_inline -p0 << 'EOF'
--- source/CMakeLists.txt
+++ source/CMakeLists.txt
@@ -78,6 +78,9 @@
     message(STATUS "Please add this value near ${CMAKE_CURRENT_LIST_FILE}:${CMAKE_CURRENT_LIST_LINE}")
 endif()
 
+include(version) # determine X265_VERSION and X265_LATEST_TAG
+include_directories(. common encoder "${PROJECT_BINARY_DIR}")
+
 if(UNIX)
     list(APPEND PLATFORM_LIBS pthread)
     find_library(LIBRT rt)
@@ -449,8 +452,6 @@
     endif()
 endif()
 
-include(version) # determine X265_VERSION and X265_LATEST_TAG
-include_directories(. common encoder "${PROJECT_BINARY_DIR}")
 
 option(ENABLE_PPA "Enable PPA profiling instrumentation" OFF)
 if(ENABLE_PPA)
EOF

SRCDIR="$SRCDIR/source"
pushd_src
BUILDDIR="$SRCDIR/../build/norm/12bit"
mkdir -p "$BUILDDIR"
cd "$BUILDDIR"
do_auto_configure -DHIGH_BIT_DEPTH=ON -DEXPORT_C_API=OFF -DENABLE_SHARED=OFF -DENABLE_CLI=OFF -DMAIN12=ON -DENABLE_LIBNUMA=OFF
do_make

BUILDDIR="$SRCDIR/../build/norm/10bit"
mkdir -p "$BUILDDIR"
cd "$BUILDDIR"
do_auto_configure -DHIGH_BIT_DEPTH=ON -DEXPORT_C_API=OFF -DENABLE_SHARED=OFF -DENABLE_CLI=OFF -DENABLE_LIBNUMA=OFF
do_make

BUILDDIR="$SRCDIR/../build/norm/8bit"
mkdir -p "$BUILDDIR"
cd "$BUILDDIR"
ln -sf ../10bit/libx265.a libx265_main10.a
ln -sf ../12bit/libx265.a libx265_main12.a
do_auto_configure -DEXTRA_LIB="x265_main10.a;x265_main12.a" -DEXTRA_LINK_FLAGS=-L. -DLINKED_10BIT=ON -DLINKED_12BIT=ON -DENABLE_LIBNUMA=OFF
do_make
do_install
popd_src
