#!/bin/bash

depends_on zlib
depends_on xz liblzo
depends_on liblz4

fetch_source https://downloads.sourceforge.net/project/squashfs/squashfs/squashfs4.3/squashfs4.3.tar.gz a615979db9cee82e4a934a1455577f597d290b41
fetch_file https://raw.githubusercontent.com/Homebrew/formula-patches/05ae0eb1/squashfs/squashfs-osx-bundle.diff bf8aad479180a0614b74d4aa2fb5b8a0c1dc567b

do_unpack
SRCDIR="$SRCDIR/squashfs-tools"
pushd_src
sed -ibak 's|#XZ_SUPPORT|XZ_SUPPORT|' Makefile
sed -ibak 's|#LZO_SUPPORT|LZO_SUPPORT|' Makefile
sed -ibak "s|/usr/local|$PREFIX/|" Makefile

do_patch "$FILENAME" -p2

do_make EXTRA_CFLAGS="$CPPFLAGS -std=gnu99" EXTRA_LDFLAGS="$LDFLAGS" LZMA_XZ_SUPPORT=1 LZ4_SUPPORT=1
do_install
popd
