#!/bin/bash

depends_on pkg-config
depends_on yasm
depends_on libopus
depends_on speex
depends_on libwebp
depends_on x264
depends_on x265
depends_on libvorbis
depends_on libxvid
depends_on libtheora
depends_on lame
depends_on zlib
depends_on bzip2
depends_on xz
depends_on libx11
depends_on libxext
depends_on libxau
depends_on libxdmcp
have_gcc 4.7 && depends_on libva ## mesa wants 4.7
[[ $OSTYPE == *linux* ]] && depends_on libasound
needs_tool bison
needs_tool flex
depends_on rtmpdump
depends_on libxv
depends_on libsdl2
depends_on libfdk-aac
depends_on libvdpau
depends_on libvpx

fetch_source https://www.ffmpeg.org/releases/ffmpeg-3.3.4.tar.xz 26a6cc311ab80bd36b38a2933a0086b4882f4395

CONFIGURE=(
--enable-pthreads
--enable-gpl
--enable-version3
--enable-shared
--enable-hardcoded-tables
--enable-avresample
--enable-nonfree
--enable-libx264
--enable-libx265
--enable-libmp3lame
--enable-libxvid
--enable-libtheora
--enable-libvorbis
--enable-ffplay
--enable-libspeex
--enable-libopus
--enable-librtmp
--enable-libfdk-aac
--enable-libwebp
--enable-libvpx
)

[[ $OSTYPE == *darwin* ]] && CONFIGURE+=(--enable-videotoolbox)

do_unpack
do_patch_inline -p0 << EOF
--- libavformat/movenc.c
+++ libavformat/movenc.c
@@ -1200,7 +1200,7 @@ static int mp4_get_codec_tag(AVFormatContext *s, MOVTrack *track)
         return 0;
 
     if      (track->par->codec_id == AV_CODEC_ID_H264)      tag = MKTAG('a','v','c','1');
-    else if (track->par->codec_id == AV_CODEC_ID_HEVC)      tag = MKTAG('h','e','v','1');
+    else if (track->par->codec_id == AV_CODEC_ID_HEVC)      tag = MKTAG('h','v','c','1');
     else if (track->par->codec_id == AV_CODEC_ID_VP9)       tag = MKTAG('v','p','0','9');
     else if (track->par->codec_id == AV_CODEC_ID_AC3)       tag = MKTAG('a','c','-','3');
     else if (track->par->codec_id == AV_CODEC_ID_EAC3)      tag = MKTAG('e','c','-','3');
EOF
do_compile "${CONFIGURE[@]}"
