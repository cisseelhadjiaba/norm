#!/bin/bash

requires_gcc 4.7

depends_on cmake  ## since llvm 3.9, cmake is the only way to build this
depends_on python ## needs python 2.7 to compile
depends_on libxml ## c-index-test has dynamic dependency on it
depends_on zlib
depends_on libffi
depends_on libedit

ENABLE_SANITIZER=yes
if ! test_cc_expr "link.h" "Elf64_Dyn a = _DYNAMIC[0]"; then
    ENABLE_SANITIZER=no
    add_caveat "Your libc doesn't have _DYNAMIC in <link.h>, sanitizer support was disabled."
fi

fetch_source http://releases.llvm.org/5.0.0/llvm-5.0.0.src.tar.xz 7b0fd212ecc38461e392cbdcbe6a1d4944138a04

do_unpack
rm -f "$SRCDIR"/configure
if [[ ${BASH_SOURCE##*/} == clang ]]; then
    fetch_source http://releases.llvm.org/5.0.0/cfe-5.0.0.src.tar.xz 8c67071be174c66264b6c7629c291c0e30ecbdc5
    intree_unpack tools/clang

    if [[ $ENABLE_SANITIZER == yes ]]; then
        fetch_source http://releases.llvm.org/5.0.0/compiler-rt-5.0.0.src.tar.xz 8fc143a222fd94ab9de4e1bd96425c459bd5f16a
        intree_unpack projects/compiler-rt
    fi

    fetch_source http://releases.llvm.org/5.0.0/clang-tools-extra-5.0.0.src.tar.xz 36fc56983d5e765a488b08a980c096b6ca61a891
    intree_unpack tools/clang/tools/extra
fi

NOPARALLEL=1 \
do_compile_outside \
	-DLLVM_OPTIMIZED_TABLEGEN=ON \
	-DLLVM_BUILD_LLVM_DYLIB=ON \
	-DLLVM_BUILD_TESTS=ON \
	-DLLVM_BUILD_EXAMPLES=OFF \
	-DLLVM_ENABLE_FFI=ON \
	-DLLVM_ENABLE_ZLIB=ON \
	-DLLVM_LINK_LLVM_DYLIB=ON
