#!/bin/bash

requires_gcc 4.7

depends_on python ## needs python 2.7 to compile
if [[ ${BASH_SOURCE##*/} == libllvm ]]; then
    depends_on zlib
    depends_on libncurses
else
    depends_on groff  ## for installing manpages
    depends_on libxml ## c-index-test has dynamic dependency on it

    ENABLE_SANITIZER=yes
    if ! test_cc_value "linux/perf_event.h" "PERF_TYPE_HARDWARE"; then
        ENABLE_SANITIZER=no
        add_caveat "Your headers are missing <linux/perf_event.h>, sanitizer support was disabled."
    fi

    if ! test_cc_value "linux/mroute6.h" "MRT6_BASE"; then
        ENABLE_SANITIZER=no
        add_caveat "Your headers are missing <linux/mroute6.h>, sanitizer support was disabled."
    fi
fi

CONFIGURE_FLAGS="--enable-optimized --disable-assertions --disable-libedit"

fetch_source http://llvm.org/releases/3.8.1/llvm-3.8.1.src.tar.xz e0c48c4c182424b99999367d688cd8ce7876827b
do_unpack

if [[ ${BASH_SOURCE##*/} == libllvm ]]; then
    TARGET_BUILD=all
    TARGET_INSTALL=install
    CONFIGURE_FLAGS+=" --enable-shared --disable-bindings"
else
    fetch_source http://llvm.org/releases/3.8.1/cfe-3.8.1.src.tar.xz b5ff24dc6ad8f84654f4859389990bace1cfb6d5
    intree_unpack tools/clang

    if [[ $ENABLE_SANITIZER == yes ]]; then
        fetch_source http://llvm.org/releases/3.8.1/compiler-rt-3.8.1.src.tar.xz be5fefcef9d035ea2db97f3396ea5ff11fdc35ed
        intree_unpack projects/compiler-rt
    fi
    TARGET_BUILD=all
    TARGET_INSTALL=install
fi

BUILDDIR="$SRCDIR"-build
rm -rf "$BUILDDIR"
mkdir -p "$BUILDDIR"
pushd "$BUILDDIR"
do_configure_outside $CONFIGURE_FLAGS
do_make $TARGET_BUILD
do_make $TARGET_INSTALL
popd
