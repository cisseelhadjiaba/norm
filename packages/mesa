#!/bin/bash

depends_on zlib
depends_on xproto
[[ $OSTYPE == *linux* ]] && depends_on libdrm

depends_on libx11
depends_on libxext
depends_on libxdamage
depends_on libxshmfence

depends_on libexpat   ## opportunistic linking, no way to disable
depends_on libelf     ## opportunistic linking, no way to disable
depends_on libxxf86vm ## opportunistic linking, no way to disable
depends_on libxvmc    ## opportunistic linking
depends_on libwayland ## opportunistic linking, mesa builds libwayland-egl used later by gstreamer
depends_on libwayland-protocols ## ditto

CONFOPTS=(
--disable-libunwind
--disable-llvm

## enable all gallium drivers that don't require llvm
--with-gallium-drivers=i915,nouveau,r600,freedreno,pl111,svga,swrast,tegra,vc4,virgl,etnaviv,imx
## these drivers require llvm: radeonsi,swr,r300
## vc5 requires the simulator

## enable vulkan drivers that don't require llvm
--with-vulkan-drivers=intel #,radeon

## gallium osmesa should be better than classic one
#--enable-osmesa
--enable-gallium-osmesa

--with-platforms=x11,drm,wayland
)

fetch_source https://mesa.freedesktop.org/archive/mesa-18.1.1.tar.xz 60d6b58f8f119b3731de587bdad30c1ecbb52678

do_unpack
do_compile "${CONFOPTS[@]}"
