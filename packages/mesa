#!/bin/bash

needs_tool autoconf automake
needs_tool pkg-config ## for autoconf macros
needs_tool libtool
depends_on zlib
depends_on xproto
[[ $OSTYPE == *linux* ]] && depends_on libdrm

depends_on libx11
depends_on libxext
depends_on libxdamage
depends_on libxfixes
depends_on libxcb
depends_on libxshmfence

depends_on libelf # r600 requires libelf when using llvm
depends_on libexpat ## opportunistic linking, no way to disable
depends_on libxxf86vm ## opportunistic linking
depends_on libxvmc ## opportunistic linking

CONFOPTS=(
--disable-libunwind
)

is_without gallium && CONFOPTS+=("--with-gallium-drivers=")

if [ -z "$DISABLE_GALLIUM" ]; then
    if ! test_cc_value "fcntl.h" "O_CLOEXEC"; then
        CONFOPTS+=("--with-gallium-drivers=")
        add_caveat "gallium in mesa was disabled -- your libc headers are too old."
    fi
fi

if [ -z "$DISABLE_GALLIUM" ]; then
    if have_gcc 4.7; then
        depends_on libllvm
    else
        CONFOPTS+=("--with-gallium-drivers=")
        add_caveat "You don't have GCC 4.7 or newer -- gallium in mesa was disabled."
    fi
fi

fetch_source https://mesa.freedesktop.org/archive/mesa-18.1.1.tar.xz 60d6b58f8f119b3731de587bdad30c1ecbb52678

do_unpack
do_autoreconf
do_compile "${CONFOPTS[@]}"
