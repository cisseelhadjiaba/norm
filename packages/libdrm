#!/bin/bash

needs_tool autoconf automake
depends_on xorg-macros
needs_tool libtool
depends_on libpciaccess
needs_tool pkg-config ## for autoconf macros

fetch_source https://dri.freedesktop.org/libdrm/libdrm-2.4.81.tar.bz2 40f0994b5fb9992e6f55d3a14537def21719d896

do_unpack
do_patch_inline -p0 << 'EOF'
--- libdrm_macros.h
+++ libdrm_macros.h
@@ -29,6 +29,11 @@
 #  define drm_private
 #endif
 
+#include <fcntl.h>
+/* XXX hack for old libc */
+#if !defined(O_CLOEXEC) && defined(__linux__)
+#define O_CLOEXEC 02000000
+#endif
 
 /**
  * Static (compile-time) assertion.
EOF
do_autoreconf
do_compile
