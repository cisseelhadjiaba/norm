#!/bin/bash

depends_on curl
depends_on openssl
depends_on libjansson

fetch_source https://github.com/hmage/cpuminer-opt/archive/45e917364df458aa986ecaed427c083ec3b68f3b.tar.gz be4b98b5538b2206aea3cb51fed7f29787a2de85

unset EXTRAFLAGS
cc_addflags EXTRAFLAGS -Ofast -flto -fuse-linker-plugin -ftree-loop-if-convert-stores -DUSE_ASM

do_unpack
do_autoreconf
pushd_src
sed -i.bak 's/aligned (16)/aligned (16),used/g' algo/groestl/sse2/grsotab.h
CFLAGS="$CPPFLAGS $EXTRAFLAGS" \
CXXFLAGS="$CPPFLAGS $EXTRAFLAGS" \
do_configure --with-crypto --with-curl
do_make
install cpuminer $PREFIX/bin/cpuminer-opt
popd_src
