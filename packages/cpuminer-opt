#!/bin/bash

depends_on autoconf automake
depends_on curl
depends_on libgmp

fetch_source https://github.com/JayDDee/cpuminer-opt/archive/badc80f071912faaa0d7fe2f09202e903de491df.tar.gz 246b7d81142a7918aa8df3f2b4cab46d40376f1b

unset EXTRAFLAGS EXTRALD
cc_addflags EXTRAFLAGS -O3 -ftree-loop-if-convert-stores -DUSE_ASM
#cc_addflags EXTRALD -Wl,--no-as-needed

do_unpack
do_autoreconf
pushd_src
CFLAGS="$CPPFLAGS $EXTRAFLAGS" \
CXXFLAGS="$CPPFLAGS $EXTRAFLAGS -std=gnu++11" \
LDFLAGS="$LDFLAGS $EXTRALD" \
do_configure --with-crypto --with-curl
do_make
install cpuminer $PREFIX/bin/cpuminer-opt
popd_src
